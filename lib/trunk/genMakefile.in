#!/bin/sh

SED=sed
SRCDIR="src"
LIBNAME="libppl7"
DEFINES="-DPPL7LIB"
DISTNAME="ppl"

######################################################################################################################
# Functions
######################################################################################################################

find_c_files() {
	# $1=Verzeichnis
	# $2=Subject
	# $3=FLAGS
	# $4=PREFIX
	# $5=Zusaetzliche Header-Dependencies
	
	COMPILE_RELEASE="$COMPILE_RELEASE
### $2"
	COMPILE_DEBUG="$COMPILE_DEBUG
### $2"
	d=`pwd`
	cd $SRCDIR/$1
	FOUND_RELEASE=""
	FOUND_DEBUG=""
	filelist=`ls *.cpp *.c 2>/dev/null`
	for file in $filelist; do
		BASENAME=`echo $file | $SED -e "s;.cpp\$;;" | $SED -e "s;.c\$;;" `
		SOURCEN="$SOURCEN $1/$file"
		if [ -n "$FOUND_RELEASE" ] ; then
			FOUND_RELEASE="$FOUND_RELEASE \\
	release/$4$BASENAME.o"
			FOUND_DEBUG="$FOUND_DEBUG \\
	debug/$4$BASENAME.o"
		else
			FOUND_RELEASE="release/$4$BASENAME.o"
			FOUND_DEBUG="debug/$4$BASENAME.o"
		fi
		###RELEASE="$RELEASE release/$4$BASENAME.o"
		
		NOTE="Compiling >>>$1/$file<<<"
		if test "$1/$file" = "core/resourcen.cpp"
		then
			NOTE="$NOTE ***** This could take some time! *****"
		fi
		ADDITIONAL_DEPENDENCY=""
		if test "$1/$file" = "grafix/CGrafix.cpp"
		then
			ADDITIONAL_DEPENDENCY="	\$(incdir)/ppl7-tk.h"
		fi
		if test "$1/$file" = "grafix/CEngine.cpp"
		then
			ADDITIONAL_DEPENDENCY="	\$(incdir)/ppl7-tk.h"
		fi
		if test "$1/$file" = "grafix/CEngineSDL.cpp"
		then
			ADDITIONAL_DEPENDENCY="	\$(incdir)/ppl7-tk.h"
		fi

		if test "$1/$file" = "core/AVLTree.cpp"
		then
			ADDITIONAL_DEPENDENCY="	\$(incdir)/ppl7-algorithms.h"
		fi

		COMPILE_RELEASE="$COMPILE_RELEASE
release/$4$BASENAME.o:	\$(srcdir)/$1/$file \$(incdir)/ppl7.h \$(incdir)/ppl7-exceptions.h \$(incdir)/ppl7-types.h \$(incdir)/ppl7-config.h Makefile $5 $ADDITIONAL_DEPENDENCY
	###############################################################################
	# $NOTE
	\$(CXX) -Wall -O3 -o release/$4$BASENAME.o -c \$(srcdir)/$1/$file \$(CFLAGS) $3
"

		COMPILE_DEBUG="$COMPILE_DEBUG
debug/$4$BASENAME.o:	\$(srcdir)/$1/$file \$(incdir)/ppl7.h \$(incdir)/ppl7-exceptions.h \$(incdir)/ppl7-types.h \$(incdir)/ppl7-config.h Makefile $5 $ADDITIONAL_DEPENDENCY
	###############################################################################
	# $NOTE
	\$(CXX) -Wall -O -o debug/$4$BASENAME.o -c \$(srcdir)/$1/$file -ggdb -D_DEBUG \$(CFLAGS) -DDEBUG=DEBUG $3
"

	done
	cd $d
}


find_asm_files() {
	# $1=Verzeichnis
	# $2=Subject
	COMPILE_RELEASE="$COMPILE_RELEASE
### $2"
	COMPILE_DEBUG="$COMPILE_DEBUG
### $2"
	d=`pwd`
	cd $SRCDIR/$1
	filelist=`ls *.asm *.c 2>/dev/null`
	for file in $filelist; do
		BASENAME=`echo $file | $SED -e "s;.asm\$;;" `
		SOURCEN="$SOURCEN $1/$file"
		if [ -n "$ASM_RELEASE" ] ; then
			ASM_RELEASE="$ASM_RELEASE \\
		release/asm_$BASENAME.o"
			ASM_DEBUG="$ASM_DEBUG \\
		debug/asm_$BASENAME.o"
		else
			ASM_RELEASE="release/asm_$BASENAME.o"
			ASM_DEBUG="debug/asm_$BASENAME.o"
		fi
		
		NOTE="Compiling >>>$1/$file<<<"
		COMPILE_RELEASE="$COMPILE_RELEASE
release/asm_$BASENAME.o:	\$(srcdir)/$1/$file Makefile
	###############################################################################
	# $NOTE
	\$(ASM) -o release/asm_$BASENAME.o -l release/asm_$BASENAME.lst \$(srcdir)/$1/$file
"

		COMPILE_DEBUG="$COMPILE_DEBUG
debug/asm_$BASENAME.o:	\$(srcdir)/$1/$file Makefile
	###############################################################################
	# $NOTE
	\$(ASM) \$(ASMDEBUGFLAGS) -o debug/asm_$BASENAME.o  -l debug/asm_$BASENAME.lst \$(srcdir)/$1/$file -D_DEBUG -DDEBUG=DEBUG
"

	done
	cd $d
}



find_c_files "core" "CORE"
RELEASE="$FOUND_RELEASE"
DEBUG="$FOUND_DEBUG"

find_c_files "types" "TYPES" "" "type_" "\$(incdir)/ppl7-types.h"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"


find_c_files "math" "MATH"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"


find_c_files "internet" "INTERNET" "" "inet_" "\$(incdir)/ppl7-inet.h"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"

find_c_files "database" "DATABASE" "" "db_" "\$(incdir)/ppl7-db.h"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"


find_c_files "grafix" "GRAFIX" "" "gfx_" "\$(incdir)/ppl7-grafix.h"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"


find_c_files "toolkit" "TOOLKIT" "" "tk_" "\$(incdir)/ppl7-grafix.h \$(incdir)/ppl7-tk.h"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"


find_c_files "sound" "SOUND" "" "sound_" "\$(incdir)/ppl7-sound.h"
SOUND_RELEASE="$FOUND_RELEASE"
SOUND_DEBUG="$FOUND_DEBUG"
RELEASE="$RELEASE \\
	$FOUND_RELEASE"
DEBUG="$DEBUG \\
	$FOUND_DEBUG"

find_asm_files "asm" "ASM"


######################################################################################################################
# Makefile.in Header
######################################################################################################################

echo "###########################################################################
###
### PPL7 Makefile
###
###########################################################################
### Global Options
###########################################################################
srcdir 	= @srcdir@/src
VPATH	= @srcdir@
incdir	= @srcdir@/include

prefix	= @prefix@
exec_prefix	= @exec_prefix@
TARGETLIB	= @libdir@
TARGETBIN	= @bindir@
TARGETINCLUDE	= @includedir@
CC			= @CC@
CXX			= @CXX@
CFLAGS		=  -I\${incdir} $DEFINES @CFLAGS@ @DEFS@  @PTHREAD_CFLAGS@ \
	@ZLIB_CFLAGS@ @BZ2_CFLAGS@ @PCRE_CFLAGS@ @OPENSSL_INCLUDES@ @ICONV_CFLAGS@ @MYSQL_CFLAGS@ @POSTGRESQL_CFLAGS@ \
	@SQLITE_CFLAGS@ \
	@LIBCURL_CPPFLAGS@  @LAME_CFLAGS@ @MPG123_CFLAGS@ @LIBMICROHTTPD_CFLAGS@ \
	@SDL_CFLAGS@ @SDL2_CFLAGS@ \
	@LIBIDN_CFLAGS@ \
	@LIBMCRYPT_CFLAGS@ @LIBMHASH_CFLAGS@ @FT2_CFLAGS@ @LIBLDNS_CFLAGS@ @IMLIB_CFLAGS@
	
	
###	@X_CFLAGS@   @SYBASE_CFLAGS@   @MAD_CFLAGS@ 
CPPFLAGS	= @CPPFLAGS@
LDFLAGS		= @LDFLAGS@
LIBS		= @OPENSSL_LDFLAGS@ @OPENSSL_LIBS@ @LIBS@ @PTHREAD_CFLAGS@ @PTHREAD_LIBS@ @ZLIB_CFLAGS@ @BZ2_LIBS@ @PCRE_LIBS@ @IMLIB_LIBS@ \
	@FT2_LIBS@ @ICONV_LIBS@ @MYSQL_LIBS@ @POSTGRESQL_LDFLAGS@ @LIBCURL@ @LAME_LIBS@ @LIBMCRYPT_LIBS@ @LIBMHASH_LIBS@ @LIBLDNS_LIBS@ @MPG123_LIBS@ \
	@SDL_LIBS@ @SDL2_LIBS@ \
	@LIBMICROHTTPD_LIBS@ @LIBIDN_LIBS@
	
###  @SYBASE_LIBS@  @MAD_LIBS@
LIBNAME		= $LIBNAME
LIBDEBUG	= $LIBNAME-debug
DISTNAME	= ${DISTNAME}
ASM			= @ASM@ @ASMFLAGS@
ASMDEBUGFLAGS	= @ASMDEBUGFLAGS@	
###########################################################################
### Object Files
###########################################################################

RELEASE	= $RELEASE

DEBUG	= $DEBUG

ASM_OBJ_RELEASE	=	$ASM_RELEASE
ASM_OBJ_DEBUG	=	$ASM_DEBUG


@HAVE_X86_ASSEMBLER@

###########################################################################
### Targets
###########################################################################


release: release/\$(LIBNAME).a

debug: debug/\$(LIBDEBUG).a

all:	install_debug install

debug/\$(LIBDEBUG).a: debug/make \$(DEBUG) \$(ASM_DEBUG)
	ar -r debug/\$(LIBDEBUG).a \$(DEBUG) \$(ASM_DEBUG)
	-chmod a+x ppl7-config

release/\$(LIBNAME).a: release/make \$(RELEASE) \$(ASM_RELEASE)
	ar -r release/\$(LIBNAME).a \$(RELEASE) \$(ASM_RELEASE)
	-chmod a+x ppl7-config

debug/make:
	-mkdir -p debug
	-touch debug/make

release/make:
	-mkdir -p release
	-touch release/make

install:	release/\$(LIBNAME).a
	-cp release/\$(LIBNAME)*.a \$(TARGETLIB)
	-cp \$(incdir)/ppl7.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-types.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-algorithms.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-exceptions.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-inet.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-grafix.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-tk.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-sound.h \$(TARGETINCLUDE)
#	-cp \$(incdir)/ppl7-crypt.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-db.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-config.h \$(TARGETINCLUDE)/ppl7-config.h
	-chmod a+x ppl7-config  
	-cp ppl7-config \$(TARGETBIN)

install_debug: debug/\$(LIBDEBUG).a
	-cp debug/\$(LIBDEBUG)*.a \$(TARGETLIB)
	-cp \$(incdir)/ppl7.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-types.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-algorithms.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-exceptions.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-inet.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-grafix.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-tk.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-sound.h \$(TARGETINCLUDE)
#	-cp \$(incdir)/ppl7-crypt.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-db.h \$(TARGETINCLUDE)
	-cp \$(incdir)/ppl7-config.h \$(TARGETINCLUDE)/ppl7-config.h
	-chmod a+x ppl7-config
	-cp ppl7-config \$(TARGETBIN)

clean:
	-rm -rf release
	-rm -rf debug
	-rm -rf documentation
	-cd tests; make clean

deinstall:
	-rm -f \$(TARGETINCLUDE)/ppl7*.h
	-rm -f \$(TARGETLIB)/\$(LIBDEBUG)*.a
	-rm -f \$(TARGETLIB)/\$(LIBNAME)*.a
	-rm -f \$(TARGETBIN)/ppl7-config
	
distclean: clean
	-rm -rf \$(incdir)/ppl7-config.h \$(incdir)/config.h config.log config.status autom4te.cache configure.scan

configure: genConfigure genMakefile.in configure.in
	-sh genConfigure

Makefile:
	-sh genMakefile.in
	
doku: html

html:
	-mkdir -p documentation
	-rm -rf documentation/html
	-mkdir -p documentation/html
	-doxygen Doxyfile
	-cp docs/header-bg.png documentation/html

test:
	- cd tests; make xml
	
memcheck:
	- cd tests; make memcheck
	 

#release/pplgenresource.o: release/make Makefile tools/pplgenresource/genresource.cpp
#	\$(CXX) -Wall -c -o release/pplgenresource.o tools/pplgenresource/genresource.cpp \$(CFLAGS)
#
#debug/pplgenresource.o: debug/make Makefile tools/pplgenresource/genresource.cpp
#	\$(CXX) -Wall -c -o debug/pplgenresource.o tools/pplgenresource/genresource.cpp \$(CFLAGS)
#
#
#res:
#	-pplgenresource -b resource -c resource/resourcen.lst -t resource/res.h -l PPL7_RESOURCES
#	-rm -f debug/resourcen.o release/resourcen.o


###########################################################################
### Compile Release Files
###########################################################################
$COMPILE_RELEASE

###########################################################################
### Compile Debug Files
###########################################################################
$COMPILE_DEBUG


" > Makefile.in


